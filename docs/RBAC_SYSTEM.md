# Система ролевого доступа (RBAC)

## Обзор

Система ролевого доступа (Role-Based Access Control) обеспечивает гибкое управление правами пользователей в зависимости от их роли в компании.

## Иерархия ролей

### 1. OWNER (Владелец компании)
- **Полные права** на все операции
- **Управление пользователями**: создание, редактирование, удаление
- **Управление ролями** и правами доступа
- **Управление компанией**: настройки, профиль
- **Все операции** с проектами, задачами, документами
- **Финансовые операции** и отчеты
- **Системные настройки**

### 2. ADMIN (Администратор)
- **Управление пользователями**: создание, редактирование, **НЕ удаление**
- **Управление ролями** (кроме OWNER)
- **Все операции** с проектами, задачами, документами
- **Финансовые операции** и отчеты
- ❌ **Удаление пользователей**
- ❌ **Изменение роли OWNER**

### 3. MANAGER (Менеджер проектов)
- **Создание и управление** проектами
- **Добавление/удаление** участников из проектов
- **Создание и назначение** задач
- **Просмотр всех документов** в проектах
- **Создание согласований**
- **Просмотр финансовых** отчетов
- ❌ **Управление пользователями** системы
- ❌ **Удаление проектов** (только архивирование)

### 4. USER (Обычный пользователь)
- **Создание документов**
- **Создание согласований**
- **Просмотр назначенных** задач
- **Обновление статуса** своих задач
- **Участие в чатах** проектов
- **Просмотр документов** в доступных проектах
- ❌ **Создание проектов**
- ❌ **Управление пользователями**
- ❌ **Финансовые операции**

## Права на уровне проекта

### Project OWNER (Создатель проекта)
- **Полное управление** проектом
- **Добавление/удаление** участников
- **Управление задачами** проекта
- **Финансовые операции** по проекту

### Project MANAGER (Менеджер проекта)
- **Управление задачами** проекта
- **Добавление участников**
- **Просмотр финансов** проекта
- ❌ **Удаление проекта**

### Project MEMBER (Участник проекта)
- **Просмотр проекта**
- **Участие в задачах**
- **Загрузка документов**
- ❌ **Управление проектом**

### Project VIEWER (Наблюдатель)
- **Только просмотр** проекта
- ❌ **Любые изменения**

## Контекстные права

### Финансовые права
- **OWNER/ADMIN**: Все финансовые операции
- **MANAGER**: Просмотр финансов, создание расходов
- **USER**: Только просмотр назначенных финансов

### Документооборот
- **OWNER/ADMIN**: Все операции с документами
- **MANAGER**: Создание, редактирование, утверждение документов
- **USER**: Создание документов, загрузка файлов

### Согласования
- **OWNER/ADMIN**: Создание любых согласований
- **MANAGER**: Создание согласований по проектам
- **USER**: Создание согласований, участие в согласовании

## Техническая реализация

### 1. Структура прав (`src/lib/permissions.ts`)
```typescript
export interface Permissions {
  canManageUsers: boolean
  canCreateUsers: boolean
  canEditUsers: boolean
  canDeleteUsers: boolean
  canChangeUserRoles: boolean
  // ... другие права
}
```

### 2. Middleware для проверки прав (`src/lib/auth-middleware.ts`)
```typescript
export async function checkPermission(
  request: NextRequest,
  permission: keyof Permissions,
  projectId?: string
): Promise<{ allowed: boolean; user: UserContext | null; error?: string }>
```

### 3. Компоненты для условного рендеринга (`src/components/permission-guard.tsx`)
```typescript
<PermissionGuard permission="canCreateUsers">
  <Button>Создать пользователя</Button>
</PermissionGuard>
```

### 4. Фильтрация данных
- **OWNER/ADMIN**: Видят все данные компании
- **MANAGER**: Видят данные проектов, где являются участниками
- **USER**: Видят только свои данные и данные доступных проектов

## UI/UX изменения

### Навигация по ролям
- **USER**: Скрыты разделы "Пользователи", "Настройки"
- **MANAGER**: Показан "Проекты", скрыт "Пользователи"
- **ADMIN/OWNER**: Полная навигация

### Кнопки действий
- **Динамическое отображение** кнопок в зависимости от прав
- **Подсказки** при отсутствии прав: "Недостаточно прав для выполнения операции"

### Фильтрация списков
- **USER**: Видит только свои проекты/задачи
- **MANAGER**: Видит проекты, где является участником или создателем
- **ADMIN/OWNER**: Видит все данные компании

## Безопасность

### Проверка на всех уровнях
- **Frontend**: Скрытие элементов интерфейса
- **API**: Проверка прав в middleware
- **Database**: Фильтрация запросов по правам

### Защита от эскалации прав
- **Запрет изменения** роли на более высокую
- **Проверка прав** при каждом запросе
- **Валидация ролей** при создании/редактировании пользователей

## Использование

### 1. Проверка прав в API
```typescript
const { allowed, user, error } = await checkPermission(request, 'canCreateUsers')
if (!allowed) {
  return NextResponse.json({ error }, { status: 403 })
}
```

### 2. Условный рендеринг в UI
```typescript
<PermissionGuard permission="canDeleteUsers">
  <Button onClick={handleDelete}>Удалить</Button>
</PermissionGuard>
```

### 3. Фильтрация данных
```typescript
const filteredData = filterDataByPermissions(data, user, 'canViewAllProjects')
```

## Дополнительные возможности

### Временные права
- Назначение временных прав на конкретные проекты
- Делегирование прав на время отпуска

### Аудит действий
- Логирование всех действий по ролям
- Отслеживание изменений прав доступа

### Групповые права
- Создание групп пользователей с общими правами
- Наследование прав от группы

## Заключение

Система RBAC обеспечивает:
- **Гибкое управление** доступом
- **Безопасность данных**
- **Понятность** для пользователей
- **Масштабируемость** для роста компании
